<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- from bootstrap template -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <script src="jquery-1.11.1.min.js"></script>

    

    <!-- from alex -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <!-- Material Design Bootstrap -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.5.11/css/mdb.min.css">
    <!-- MDB core JavaScript -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.5.11/js/mdb.min.js"></script>


    <link href="styles.css" rel="stylesheet"/>

    <meta http-equiv='Pragma' content='no-cache'>
    <meta http-equiv='Expires' content='-1'>

    <title>Food Data        </title>

    <!-- from bootstrap -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body role="document">
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="loggedIn.html">FoodData</a>
    </div>
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav">
        <li class="active" id="searchNav"><a href="loggedIn.html">Search</a></li>

                    <li id="userNav"><a href="user.html">User</a></li>
            <li id="socialNav"><a href="social.html">Social</a></li>
              </ul>
      <ul class="nav navbar-nav navbar-right">
      <li id="loginNav"><a href="logout.html"><span class="glyphicon glyphicon-log-in"></span>
Log out</a></li>
      </ul>
    </div>
  </div>
</nav>

    <div id="top">
        <img class="center-block" height="120" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTVehmHJrXNRaFSiD2mmexUgE0sXK52smE-EtPrPikUhP-2EZoQ" />
    </div>


    <div id="middle1">
        <div class="container">
<div class="row spaceTop">
    <div class="col-sm-6">

        <div class="input-group">
            <input id="search" type="text" 
                class="form-control" name="search" placeholder="Search">
            <div class="input-group-btn">
                <button class="btn btn-default" id="searchBtn"
                ><i class="glyphicon glyphicon-search"></i></button>
            </div>
        </div>

    </div>
    <div class="col-sm-6">
        <button id="cmpBtn" style="display:none"
            class="btn btn-danger input-block-level form-control">
            Compare
        </button>
    </div>
</div>
<div class="row spaceTop">
    <div class="col-sm-6">

        <div class="form-group">
            <label for="list">List of Foods</label>
            <select multiple class="form-control" id="list">
                <option>Smoothie</option>
                <option>Sandwich</option>
                <option>Juice</option>
                <option>Bread</option>
                <option>Apples</option>
                <option>Apricots</option>
                <option>Ammonia cookie</option>
                <option>Cuisine of Antebellum America</option>
                <option>Apple butter</option>
                <option>Apple sauce</option>
                <option>Baked potato</option>
                <option>Barbecue (see below for specific types)</option>
                <option>Bear claw</option>
                <option>Beef Manhattan</option>
                <option>Blue cheese dressing</option>
                <option>Blue-plate special</option>
                <option>Bookbinder soup</option>
                <option>Breakfast burrito</option>
                <option>Brunswick stew</option>
                <option>Buffalo burger</option>
                <option>Buffalo wing</option>
                <option>Bull roast</option>
                <option>Burnt ends</option>
                <option>Butter cookie</option>
                <option>Cajun cuisine</option>
                <option>Calf's liver and bacon</option>
            </select>
        </div>

    </div>
    <div class="col-sm-6">
        <h3>Nutritional Information</h3>
        <p id="info">
        </p>
        <button class="btn btn-danger" id="addBtn" style="display: none">Add to meal</button>
    </div>
</div>
<div id="myMeal" class="row spaceTop" style="display:none">
    <div class="col-sm-9" id="mealItems">
        <h3>Create a meal</h3>
    </div>
    <div class="col-sm-3">
        <h3> _</h3>
        <button id="saveMeal" class="btn btn-danger">
            Save Meal
        </button>
    </div>

</div>
<div class="row spaceTop">
    <div class="col-sm-12">
        <h3>My Meals</h3>
        <table class="table" id="mealList">
            <tr>
            </tr>
        </table>
    </div>
</div>

</div>
</div>

    <div id="bottom">
        Created by YouAreWhatYouEat Inc. All rights reserved
    </div>

  <!-- Modal -->
  <div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">
    
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Comparing food</h4>
        </div>
        <div class="modal-body">
          <p>Comparing food items.</p>
          <table class="table">
            <tr>
                <th></th>
                <th id="item1">Item</th>
                <th id="item2">Item</th>
            </tr>
            <tr>
                <td>Calories: </td>
                <td id="cal1"> </td>
                <td id="cal2"> </td>
            </tr>
            <tr>
                <td>Protein: </td>
                <td id="prot1"> </td>
                <td id="prot2"> </td>
            </tr>
            <tr>
                <td>Vitamin: </td>
                <td id="vit1"> </td>
                <td id="vit2"> </td>
            </tr>
            <tr>
                <td>Sugar: </td>
                <td id="sugar1"> </td>
                <td id="sugar2"> </td>
            </tr>
            <tr>
                <td> </td>
                <td><button data="0" class="btn btn-default add">Add to Meal</button></td>
                <td><button data="1" class="btn btn-default add">Add to Meal</button></td>
            </tr>
          </table>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Name of Meal -->
  <div class="modal fade" id="mealModal" role="dialog">
    <div class="modal-dialog">
    
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Name Meal</h4>
        </div>
        <div class="modal-body">
          <p>You are about to save this meal.</p>
          <p>Please enter a name to save this meal</p>
          <p id="modalMessage" style="display: none; color: red">
            Please enter a name to save this meal
          </p>

            <div class="form-group">
                <label for="mealName">Name:</label>
                <input type="text"
                    class="form-control" id="mealName" placeholder="Name of meal">
            </div>

        </div>
        <div class="modal-footer">
            <button type="button" id="saveMealModal" class="btn btn-success" 
                >Save</button>
            <button type="button" 
                class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
<script src="notify.js"></script>
<script src="ws.js"></script>
<script src="search.js"></script>
<script>
$(".nav li").removeClass("active");
$("#searchNav").addClass("active");
// button from modal
$(".add").click(function(){
    $("#myModal").modal("hide");
    let item = $(this).attr("data") ;
    console.log("adding " + s[item].foodName);
    addFoodToMeal(s[item].foodId, s[item].foodName);
});
// add button
$("#addBtn").click(function(){
    // add to my meal
    var selected = $("#list").children("option:selected");
    $.each(selected, function(i,d){
        var id = d.attributes.id.value;
        id = id.substr(1);
        console.log(id + " " + d.text);
        addFoodToMeal(id, d.text);
    });
});
var mealItems = [];
function addFoodToMeal(id, name) {
    // add to meal items
    mealItems.push(id);
    // add button
    $("#myMeal").show();
    let str = '<button class="btn btn-default mealFood" item="' + id
        + '">' + name + ' X </button>';
    $("#mealItems").html( $("#mealItems").html() + str );
    // listener to delete
    $(".mealFood").click(function() {
        // remove data
        let id = $(this).attr("item");
        mealItems.splice(mealItems.indexOf(id), 1);
        // remove button
        $(this).remove();
    });
}
$("#saveMeal").click(function(){
    // hide warning message
    $("#modalMessage").hide();
    $("#mealName").val("");
    // display modal
    $("#mealModal").modal();
    $("#mealName").focus();
});
// this comes from the modal when saving a meal
$("#saveMealModal").click(function(){
    // if no name
    if($("#mealName").val() == "") {
        $("#modalMessage").show();
        return;
    }
    // pass to backedn
    $.post("SearchEngine", {
        type: "saveMeal",
        name: $("#mealName").val(),
        content: JSON.stringify( mealItems )
    })
    .done(function(d){
        // print response
        console.log("response: " + d);
        try{
            var json = JSON.parse(d);
            // capture meal and diplay it
            displayMeal(json.mealId);
            $("#mealModal").modal("hide");
            $(".mealFood").each(function(){
                $(this).click();
            });
        } catch(e) {
            console.log("Problem parsing");
        }
        // hide create my meal div
        $("#myMeal").hide();
    });
});
function displayMeal(mealId) {
    console.log(mealId);
    let name = $("#mealName").val();
    let ingredients = "";
    let first = true;
    $(".mealFood").each(function(i,d){
        if(!first) { ingredients += ", "; }
        else {
            first = false;
        }
        let name = d.innerHTML;
        name = name.substr(0, name.length - 3);
        ingredients += name;
    });
    addMealRow(mealId, name, ingredients, "Private");
}
function addMealRow(mealId, name, ingredients, privacyS) {
    let privacy = (privacyS == "Public") ? "Sharing with Friends" : "Private";
    let buttonVal = (privacyS == "Public") ? "Make Private" : "Share";
    let str = '<tr id="r'+ mealId +'"><td>' + name + '</td>'
        + '<td>' + ingredients + '</td>'
        + '<td id="p'+mealId+'">' + privacy + '</td><td>'
        + '<button class="btn btn-default share" mealId="'+mealId+'">' + buttonVal + '</button>'
        + '</td><td>'
        + '<button class="btn btn-default delete" mealId="'+mealId+'">X</button>'
        + '</td>';
    
    $(str).prependTo("#mealList > tbody");
    // listener for buttons
    $(".share").click(function(){
        let mealId = $(this).attr("mealid");
        console.log("sharing meal with id " + mealId);
        var obj = $(this);
        $.post("SearchEngine", {
            type: "toggleMealPrivacy",
            mealId: mealId
        })
        .done(function(d){
            console.log("response " + d);
            var json = JSON.parse(d);
            let privacy = (json.newStatus == "Public") ? "Sharing with Friends" : "Private";
            let buttonVal = (json.newStatus == "Public") ? "Make Private" : "Share";
            $("#p"+ mealId).text(privacy);
            obj.text( buttonVal );
        });
    });
    $(".delete").click(function(){
        let mealId = $(this).attr("mealid");
        console.log("deleting meal id " + mealId);
        $.post("SearchEngine", {
            type: "deleteMeal",
            mealId: mealId
        })
        .done(function(d){
            console.log("response " + d);
            $("#r"+ mealId).remove();
        });
    });
}
$(function() {
    $.post("SearchEngine", {
        type: "getMeals",
    })
    .done(function(data) {
        var json = JSON.parse(data);
        
        $.each(json, function(i, meal) {
            addMealRow(meal.mealId, meal.name, meal.foodItems, meal.privacy);
        });
    });
});
</script>
</body>
</html>